# Makefile for TravisCI

# Variable settings
CXXFLAGS=-std=c++11 -Wall -Wextra -I/usr/local/share/mbedtls/include/ -L/usr/local/share/mbedtls/library/ -pthread
LIBS=-lmbedcrypto -ldl
SOURCES_COMMON=src/common/ipv4.cpp
# Source and object lists for testing binary
SOURCES_SERVER=$(SOURCES_COMMON) src/server/sqlite3.cpp src/server/database.cpp src/server/client.cpp src/server/serverManager.cpp

SOURCES_TESTS=$(SOURCES_SERVER) src/tests/main.cpp
OBJECTS_TESTS=$(SOURCES_TESTS:.cpp=.o)

# Most frequently used automatic variables:
# $@ (name of the target rule)
# $< (name of the first prerequisite)
# $^ (name of all the prerequisites)

# Target anatomy:
# name: dependency1 dependency2
# <tab> command to run
# <tab> other command to run

# Target 'all' has 'main' and 'main-test' as dependencies.
# It is the first defined target (so it's run if no target is specified from CLI).
all: main-test

# Depends on main-test, runs the test program.
test: main-test
	./main-test

# Depends on all object files and test, links the test binary.
main-test: $(OBJECTS_TESTS)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS)

# Automatic rule for all object files in build directory
%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(LIBS) -c -o $@ $<

clean:
	rm -fr $(OBJECTS_TESTS)
	cd src/mbedtls && $(MAKE) clean
